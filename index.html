<html>

<head>
    <title>
        My first NFT game
    </title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/moralis/dist/moralis.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser.js"></script>
</head>

<body>
    <h1>Testing...</h1>
    <button id="btn-login">Moralis login</button>
    <button id="btn-logout">Logout</button>
    <button id="btn-get-stats">Refresh Stats</button>

    <ul id="stats"></ul>

    <div style="width:100%; height:100%; position:absolute; display:flex; border: 1px;">

        <script>
            const serverUrl = "https://hhf94m4l0ue4.usemoralis.com:2053/server";
            const appId = "TElNqqhKFrv95nPwXyUNldKipwaOJFK0R5GZXmlg";
            Moralis.start({ serverUrl, appId });

            async function login() {
                let user = Moralis.User.current();
                if (!user) {
                    user = await Moralis.authenticate();
                }
                console.log("logged in user: ", user);
                getStats();
            }

            async function logout() {
                await Moralis.User.logOut();
                console.log("logged out");
            }

            function getStats() {
                if (true) {
                    return;
                }
                const user = Moralis.User.current();
                if (user) {
                    getUserTransactions(user);
                }
                // getAveragePrices();
            }

            async function getUserTransactions(user) {
                const query = new Moralis.Query("EthTransactions");
                query.equalTo("from_address", user.get("ethAddress"));

                const subscription = await query.subscribe();
                handleNewTransaction(subscription);

                const results = await query.find();
                console.log("user transactions: ", results);
            }

            async function handleNewTransaction(subscription) {
                subscription.on("create", function (data) {
                    console.log("new transaction: ", data);
                });
            }

            async function getAveragePrices() {
                const results = await Moralis.Cloud.run("getAvg");
                console.log("average user prices: ", results);
                renderStats(results);
            }

            function renderStats(data) {
                const container = document.getElementById("stats");
                container.innerHTML = data
                    .map(function (row, rank) {
                        return `<li>#${rank + 1}: ${Math.round(row.avg)} gwei</li>`;
                    })
                    .join("");
            }

            getStats();

            document.getElementById("btn-login").onclick = login;
            document.getElementById("btn-logout").onclick = logout;
            document.getElementById("btn-get-stats").onclick = getStats;

            var config = {
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                physics: {
                    default: 'arcade',
                    arcade: {
                        gravity: { y: 1000, x: 1e-12 },
                        debug: true
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            var game = new Phaser.Game(config);
            var platforms;
            var player;
            var cursors;
            var cactuses = [];

            var jumpHeight = -400;

            var baseSpeed = -5;
            var maxSpeed = -15;
            var acceleration = -0.1;
            var currentSpeed;
            var gameOver = false;

            var score = 0;
            var scorePeriod = 30;
            var time = scorePeriod;
            var scoreText;
            var highScoreText;


            function preload() {
                this.load.image('background', 'assets/bg_desert.png');
                this.load.image('ground', 'assets/sandCenter_rounded.png');
                this.load.image('player', 'assets/alienBeige_stand.png');
                this.load.image('cactus', 'assets/cactus.png');
            }

            function create() {
                this.add.image(400, 300, 'background');

                let init, dinit;
                cactuses = this.physics.add.staticGroup();
                cactuses.create(Math.random() * 100 + config.width, 532, 'cactus').setScale(0.7).refreshBody();
                for (let c in cactuses.getChildren()) {
                    cactuses.getChildren()[c].body.x += 10;
                    cactuses.getChildren()[c].body.y += 10;
                    cactuses.getChildren()[c].body.width -= 20;
                    cactuses.getChildren()[c].body.height -= 10;
                }


                platforms = this.physics.add.staticGroup();
                init = 21;
                dinit = init * 2;
                for (let i = init; i < config.width + dinit; i += dinit) {
                    platforms.create(i, 579, 'ground').setScale(0.67).refreshBody();
                }

                player = this.physics.add.sprite(30, 400, 'player').setScale(0.7).refreshBody();

                this.physics.add.collider(player, platforms);
                this.physics.add.collider(player, cactuses);

                cursors = this.input.keyboard.createCursorKeys();
                currentSpeed = baseSpeed;

                scoreText = this.add.text(16, 10, 'Score: 0', { fontSize: '32px', fill: '#FFF' });

                let oldHighScore = document.cookie.split('=')[1];
                highScoreText = this.add.text(516, 10, 'High Score: ' + oldHighScore, { fontSize: '32px', fill: '#FFF' });
            }

            function update() {
                if (gameOver || !player) {
                    return;
                }
                for (let i in cactuses.getChildren()) {
                    gameOver = player.body.touching.right || player.body.touching.down && cactuses.getChildren()[i].body.touching.up;
                    if (gameOver) {
                        document.cookie = 'high-score' + "=" + score;
                        let oldHighScore = document.cookie.split('=')[1];
                        if (score > oldHighScore) {
                            document.cookie.replace(oldHighScore, score);
                        }
                        alert('GameOver');
                        return;
                    }
                }
                time--;
                if (time == 0) {
                    score++;
                    time = scorePeriod;
                    scoreText.setText('Score: ' + score);
                }
                if (currentSpeed < maxSpeed) {
                    currentSpeed = maxSpeed;
                }
                else if (currentSpeed > maxSpeed) {
                    currentSpeed += acceleration / 60;
                }

                for (let i in cactuses.getChildren()) {
                    cactuses.getChildren()[i].x += currentSpeed;
                    cactuses.getChildren()[i].body.x += currentSpeed;
                }

                if (cursors.up.isDown && player.body.touching.down) {
                    player.setVelocityY(jumpHeight);
                }

                for (let i in cactuses.getChildren()) {
                    if (cactuses.getChildren()[i].body.x < -cactuses.getChildren()[i].width) {
                        let newX = Math.random() * 100 + config.width;
                        cactuses.getChildren()[i].body.x += newX;
                        cactuses.getChildren()[i].x += newX;
                    }
                }
            }

        </script>

    </div>
</body>

</html>