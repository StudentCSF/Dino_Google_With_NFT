<html>

<head>
    <title>
        My first NFT game
    </title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/moralis/dist/moralis.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.51.0/dist/phaser.js"></script>
</head>

<body>
    <h1>Testing...</h1>
    <button id="btn-login">Moralis login</button>
    <button id="btn-logout">Logout</button>
    <button id="btn-get-stats">Refresh Stats</button>

    <ul id="stats"></ul>

    <div style="width:100%; height:100%; position:absolute; display:flex; border: 1px;">

        <script>
            const serverUrl = "https://hhf94m4l0ue4.usemoralis.com:2053/server";
            const appId = "TElNqqhKFrv95nPwXyUNldKipwaOJFK0R5GZXmlg";
            Moralis.start({ serverUrl, appId });

            async function login() {
                let user = Moralis.User.current();
                if (!user) {
                    user = await Moralis.authenticate();
                }
                console.log("logged in user: ", user);
                getStats();
            }

            async function logout() {
                await Moralis.User.logOut();
                console.log("logged out");
            }

            function getStats() {
                if (true) {
                    return;
                }
                const user = Moralis.User.current();
                if (user) {
                    getUserTransactions(user);
                }
                // getAveragePrices();
            }

            async function getUserTransactions(user) {
                const query = new Moralis.Query("EthTransactions");
                query.equalTo("from_address", user.get("ethAddress"));

                const subscription = await query.subscribe();
                handleNewTransaction(subscription);

                const results = await query.find();
                console.log("user transactions: ", results);
            }

            async function handleNewTransaction(subscription) {
                subscription.on("create", function (data) {
                    console.log("new transaction: ", data);
                });
            }

            async function getAveragePrices() {
                const results = await Moralis.Cloud.run("getAvg");
                console.log("average user prices: ", results);
                renderStats(results);
            }

            function renderStats(data) {
                const container = document.getElementById("stats");
                container.innerHTML = data
                    .map(function (row, rank) {
                        return `<li>#${rank + 1}: ${Math.round(row.avg)} gwei</li>`;
                    })
                    .join("");
            }

            getStats();

            document.getElementById("btn-login").onclick = login;
            document.getElementById("btn-logout").onclick = logout;
            document.getElementById("btn-get-stats").onclick = getStats;

            var config = {
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                physics: {
                    default: 'arcade',
                    arcade: {
                        gravity: { y: 300 },
                        debug: false
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };

            var game = new Phaser.Game(config);
            var platforms;
            var player;
            var cursors;
            var cactuses;

            var jumpHeight = -200;

            var baseSpeed = -5;
            var maxSpeed = -15;
            var acceleration = -0.01
            var currentSpeed;


            function preload() {
                this.load.image('background', 'assets/bg_desert.png');
                this.load.image('ground', 'assets/sandCenter_rounded.png');
                this.load.image('player', 'assets/alienBeige_stand.png');
                this.load.image('cactus', 'assets/cactus.png');
            }

            function create() {
                this.add.image(400, 300, 'background');

                let init, dinit;
                cactuses = this.physics.add.staticGroup();
                cactuses.create(Math.random() * 100 + config.width, 532, 'cactus').setScale(0.7).refreshBody();
                cactuses.children.entries[0].body.position.x = 150;

                platforms = this.physics.add.staticGroup();
                init = 21;
                dinit = init * 2;
                for (let i = init; i < config.width + dinit; i += dinit) {
                    platforms.create(i, 579, 'ground').setScale(0.67).refreshBody();
                }

                player = this.physics.add.sprite(30, 400, 'player').setScale(0.7).refreshBody();

                this.physics.add.collider(player, platforms);

                cursors = this.input.keyboard.createCursorKeys();
                currentSpeed = baseSpeed;
            }

            function update() {
                for (let cac in cactuses.children.entries){//.children.entries) {
                    // if (cac.x)
                    console.log('b: ', cac.x);
                    cac.x = cac.x + currentSpeed / 60 + acceleration^2 / (2 * 60);
                }

                // if (player.x > )
                // cactuses.children.entries[0].x += 0;
                // console.log('cc: ', cactuses.children.entries[0].body.position);
                if (!player) {
                    return;
                } else if (cursors.up.isDown && player.body.touching.down) {
                    player.setVelocityY(jumpHeight);
                }
            }

        </script>

    </div>
</body>

</html>